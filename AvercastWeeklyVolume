USE [PowerBIWarehouse]
GO

/****** Object:  View [dbo].[AvercastWeeklyVolume]    Script Date: 15/12/2023 09:11:10 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



ALTER VIEW [dbo].[AvercastWeeklyVolume] AS

WITH 

MonthlyQuant AS(
SELECT
AVI.Site,
AVI.SKU,
year(AVI.Date) 'Year',
month(AVI.Date) 'Month', 
SUM(AVI.Quantity) 'MonthlyQuant'
FROM dbo.[AvercastVolumeInput] AVI
Group by
AVI.Site,
AVI.SKU,
year(AVI.Date),
month(AVI.Date)
),

MonthRemaining AS(
SELECT
AVI.Site,
AVI.SKU,
year(AVI.Date) 'Year',
month(AVI.Date) 'Month', 
count(AVI.SKU) 'NoWeeks'
FROM dbo.[AvercastVolumeInput] AVI  WHERE year(AVI.Date)=year(getdate()) AND month(AVI.Date)=month(getdate()) AND AVI.Date>=dateadd(day,-7,getdate())
Group by
AVI.Site,
AVI.SKU,
year(AVI.Date),
month(AVI.Date)
),

DeliveredQuant AS(
SELECT
D.ShipmentSite,
D.Product,
year(d.ShipmentDate) 'Year',
month(d.ShipmentDate) 'Month', 
SUM(D.Deliveredquantity) 'Shipped'
FROM [MES].[DeliveryDetail] D
Group by
D.ShipmentSite,
D.Product,
year(d.ShipmentDate),
month(d.ShipmentDate) 
)


SELECT
AVI.Site,
AVI.SKU,
AVI.Date,
--AVI.Quantity 'Avercast weekly Prediction',
--MQ.monthlyquant 'Total prediction for that month',
--DQ.Shipped 'Total Shipped for that month (By shippment date)',
--MR.noweeks 'No. weeks remaining in current month',

CASE WHEN (year(AVI.Date)=year(getdate()) AND month(AVI.Date)>Month(getdate())) OR year(AVI.Date)>year(getdate()) THEN AVI.Quantity
     WHEN AVI.Date>=DATEADD(day,-7,getdate()) AND year(AVI.Date)=year(getdate()) AND month(AVI.Date)=Month(getdate()) THEN (CASE WHEN MQ.monthlyquant>DQ.Shipped THEN (MQ.monthlyquant-ISNULL(DQ.Shipped,0))/MR.noweeks ELSE 0 END)
	 WHEN AVI.Date<DATEADD(day,-7,getdate()) THEN DQ.Shipped
	 ELSE 0 END  'Prediction',--- add an if actual is more than predicted then 0

CASE WHEN (year(AVI.Date)=year(getdate()) AND month(AVI.Date)>Month(getdate())) OR year(AVI.Date)>year(getdate()) THEN 'Prediction' 
     WHEN AVI.Date>=DATEADD(day,-7,getdate()) AND year(AVI.Date)=year(getdate()) AND month(AVI.Date)=Month(getdate()) THEN 'Prediction adjusted' 
	 WHEN AVI.Date<DATEADD(day,-7,getdate()) THEN 'Actual'
	 ELSE 'Error' END  'Type'


FROM dbo.[AvercastVolumeInput] AVI
LEFT JOIN MonthlyQuant MQ ON AVI.Site=MQ.Site AND AVI.SKU=MQ.SKU AND year(AVI.Date)= MQ.Year AND month(AVI.Date) = MQ.Month
LEFT JOIN MonthRemaining MR ON AVI.Site=MR.Site AND AVI.SKU=MR.SKU AND year(AVI.Date)= MR.Year AND month(AVI.Date) = MR.Month
LEFT JOIN DeliveredQuant DQ ON AVI.Site=DQ.ShipmentSite AND AVI.SKU=DQ.Product AND year(AVI.Date)= DQ.Year AND month(AVI.Date) = DQ.Month

GO


